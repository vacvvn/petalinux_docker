# общие сведения
Комплект для сборки docker образа в котором будут установлены:
- ubuntu 16.04
- petalinux 2018.3 - toolkit для разработки ПО
- sstate-rel-v2018.3.tar.gz - полный набор зависимостей для сборки
- xilinx-zcu102-v2018.3-final.bsp - board support package для отладочной платы zcu-102

>Dockerfile создан на основе [примера](https://github.com/z4yx/petalinux-docker/blob/master/Dockerfile)

# параметры по умолчанию
>[!NOTE] Важно

В Dockerfile заданы параметры по умолчанию:
- *UID_val*: UID пользователя, под которым будет создаваться проект
    - по умолчанию 1000
- *GID_val*: GID пользователя, для которой будет создаваться проект
    - по умолчанию 1000
- *LOGIN_str*: имя пользователя
    - по умолчанию vivado
- *PETA_VERSION*: версия petalinux
    - по умолчанию 2018.3
- *PETA_RUN_FILE*: установочный файл petalinux
- *PETA_INST_PATH*: путь для установки системы сборки, зависимостей и bsp

>Если параметры по умолчанию не подходят, придется пересобирать образ с новыми параметрами.
>Любой параметр можно изменить либо в Dockerfile, либо задать в виде параметра ком.строки при сборке нового образа. Пример команды для сборки образа:
> ```bash
> docker build --build-arg GID_val=1234  --build-arg UID_val=1234 -t petalinux:2018.3 .
> ```

# сборка образа
Если не требуется задавать особые параметры, команда сборки образа может выглядеть следующим образом:
```bash
docker build -t petalinux:2018.3 .
```
При сборке образа в него копируется файл `bsp` для платы `zcu102`. После запуска контейнера этот файл используется для создания проектов. Если этот файл не требуется, его можно удалить из директории installer и закомментировать соответствующую строку в Dockerfile.

При сборке образа в него распаковывается архив зависимостей `sstate`. После запуска контейнера этот архив используется для сборки проектов. Для его использования при конфигурации проекта в разделе `Yocto Setting->Local sstate feeds settings` нужно прописать путь до директории aarch64 распакованного архива. Архив `sstate` будет распакован в `${PETA_INST_PATH}/${PETA_VERSION}/sstate/`. Переменные нужно заменить на их действительные значения.

## размер образа
>Размер образа составляет примерно 50ГБ.

Файл зависимостей и bsp файл копируются в образ и имеют большой объем. При установке petalinux эти файлы не используются. Т.о. для уменьшения размера образа можно изменить Dockerfile:
- можно закомментировать распаковку архива `sstate` в образ.
    - В этом случае при сборке проекта система сборки будет скачивать зависимости с внешних ресурсов.
    - если `sstate` уже присутствуют на хост системе, можно смонтировать эту директорию в контейнер при его запуске. Для ее использования при конфигурации проекта в разделе `Yocto Setting->Local sstate feeds settings` нужно прописать путь до поддиректории aarch64 смонтированной директории.
- Если файл `bsp` есть на хосте, то можно закомментировать копирование в образ файла `bsp`
    - В этом случае при создании проекта папка с внешним `bsp` файлом должна быть смонтирована в контейнер.

# запуск контейнера
Предполагается, что контейнер будет запускаться с монтированием рабочей директории хоста в контейнер. В этой директории будут создаваться, собираться и модифицироваться проекты.

>Предпочтительно, чтобы UID/GID владельца примонтированной внешней директории совпадал с UID/GID под которыми в образе установлен petalinux и под которым будет создаваться проект. Если UID/GID не совпадают, можно пересобрать образ под [[#параметры по умолчанию|нужные параметры]]
Пример команды запуска контейнера:
```bash
# проектная директория хоста смонтируется в директорию /home/vivado/project контейнера
docker run -it --rm --mount type=bind,source=/absolute/path/to/project/folder/,target=/home/vivado/project  petalinux:2018.3
```

# детали
В директории контекста сборки во вложенной директории installer лежат файлы инсталлятора petalinux, файл bsp для платы

